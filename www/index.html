<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Apps-Name</title>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Security-Policy" content="default-src *; style-src *  'unsafe-inline'; script-src *  'unsafe-inline'; media-src *">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link rel="stylesheet" href="css/materialize.min.css">
        <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
        <script type="text/javascript" src="cordova.js"></script>
        <script src="js/jquery-3.3.1.js"></script>
        <script src="js/materialize.min.js"></script>
        <script src="app_js/config.js"></script>
    </head>
    <body>
        <nav class="teal lighten-1 navbar-fixed">
            <center>
                <a href="#!" class="brand-logo">Yuhu POS</a>
                <!--<a href="#" data-target="slide-out" class="sidenav-trigger">Yuhu POS</a>-->
            </center>
        </nav>
        <div class="row">
            <div class="col s3"></div>
            <form id="login-form" class="col s6">
                <div class="row">
                    <br>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <input id="email" name="username" type="text" class="validate">
                        <label for="email">Username</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <input id="password" name="password" type="password" class="validate">
                        <label for="password">Password</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12">
                        <button type="submit" class="waves-effect waves-light btn">LOGIN</button>
                    </div>
                    <div class="col s12">
                        <a class="waves-effect waves-light btn">Print</a>
                    </div>
                </div>
            </form>
            <div class="col s3"></div>
        </div>
        <script>

            document.addEventListener("deviceready", onDeviceReady, false);

            function onDeviceReady() {
                // Now safe to use device APIs
                var enabled = false;
                networking.bluetooth.getAdapterState(function (adapterInfo) {
                    enabled = adapterInfo.enabled;
                });

                networking.bluetooth.onAdapterStateChanged.addListener(function (adapterInfo) {
                    // The adapterInfo object has the same properties as getAdapterState
                    if (adapterInfo.enabled !== enabled) {
                        enabled = adapterInfo.enabled;
                        if (enabled) {
                            console.log('Adapter is enabled');
                        } else {
                            console.log('Adapter is disabled');
                        }
                    }
                });


                networking.bluetooth.getAdapterState(function (adapterInfo) {
                    // The adapterInfo object has the following properties:
                    // address: String --> The address of the adapter, in the format 'XX:XX:XX:XX:XX:XX'.
                    // name: String --> The human-readable name of the adapter.
                    // enabled: Boolean --> Indicates whether or not the adapter is enabled.
                    // discovering: Boolean --> Indicates whether or not the adapter is currently discovering.
                    // discoverable: Boolean --> Indicates whether or not the adapter is currently discoverable.
                    alert('Adapter ' + adapterInfo.address + ': ' + adapterInfo.name);
                }, function (errorMessage) {
                    alert(errorMessage);
                });


                var uuids_bth = [];
                networking.bluetooth.getDevices(function (devices) {
                    for (var i = 0; i < devices.length; i++) {
                        // The deviceInfo object has the following properties:
                        // address: String --> The address of the device, in the format 'XX:XX:XX:XX:XX:XX'.
                        // name: String --> The human-readable name of the device.
                        // paired: Boolean --> Indicates whether or not the device is paired with the system.
                        // uuids: Array of String --> UUIDs of protocols, profiles and services advertised by the device.
                        console.log(devices[i].address);
                    }

                    var uuid = devices[0].uuids[0];
                    alert(uuid);

                    networking.bluetooth.connect(device.address, uuid, function (socketId) {

                        var CHAR_ESC = 0x1b;
                        var LINE_FEED = '\n';
                        var CARRIAGE_RETURN = '\r';

                        var data = "! 0 200 200 500 1" + CARRIAGE_RETURN + LINE_FEED +
                                "TEXT 4 0 0 45 sometext" + CARRIAGE_RETURN + LINE_FEED +
                                "TEXT 4 0 155 45 Lorem ipsum" + CARRIAGE_RETURN + LINE_FEED +
                                "INVERSE-LINE 0 45 145 45 45" + CARRIAGE_RETURN + LINE_FEED +
                                "PRINT" + CARRIAGE_RETURN + LINE_FEED;

                        arrayBuffer = [];
                        arrayBuffer.push(data);

                        networking.bluetooth.send(socketId, arrayBuffer, function (bytes_sent) {

                            alert('Sent ' + bytes_sent + ' bytes');
                        }, function (errorMessage) {
                            alert('Send failed: ' + errorMessage);
                        });

                    }, function (errorMessage) {
                        alert('Connection failed: ' + errorMessage);
                    });

                });


                $('#coba-print').click(function () {



                });

            }

            $(document).ready(function () {
                $('#login-form').submit(function (e) {
                    e.preventDefault();


                    var username = $('input[name=username]').val();
                    var password = $('input[name=password]').val();

                    window.localStorage.setItem('cart', '');

                    window.localStorage.setItem('username', username);
                    window.localStorage.setItem('password', password);


                    $.ajax({
                        url: app_hostname + 'user/login',
                        crossDomain: true,
                        data: {
                            username: username,
                            password: password,
                        },
                        type: 'POST',
                        success: function (data, textStatus, jqXHR) {
                            console.log(data);
                            if (data['succes']) {
                                window.location = "dashboard.html";
                            } else {
                                alert(data['error']);
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert(JSON.stringify(jqXHR));
                            alert(JSON.stringify(textStatus));
                            alert(JSON.stringify(errorThrown));
                        }
                    });
//                    window.location = "index.html";
                });
            });
        </script>

    </body>
</html>
